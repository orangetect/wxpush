name: Full Upstream Sync (Best Version)

on:
  schedule:
    - cron: "0 18 * * *"
  workflow_dispatch:
  watch:
    types: [started]

env:
  UPSTREAM_REPO: "https://github.com/xxxxx/xxxxx.git"
  SYNC_BRANCH_PREFIX: "sync-upstream"
  SYNC_BRANCHES: "main dev release"
  TELEGRAM_ENABLE: "true"
  DISCORD_ENABLE: "false"

jobs:
  sync:
    runs-on: ubuntu-latest
    if: github.event.repository.owner.id == github.event.sender.id

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          if git remote | grep -q '^upstream$'; then
            echo "Upstream exists."
          else
            git remote add upstream $UPSTREAM_REPO
          fi
          git fetch upstream --tags

      - name: Sync branches
        run: |
          BRANCHES=""
          for BR in $SYNC_BRANCHES; do
            echo ">>> Syncing branch: $BR"
            if ! git branch -a | grep -q "origin/$BR"; then
              echo "Branch $BR not found, skip."
              continue
            fi
            SYNC_BRANCH="${SYNC_BRANCH_PREFIX}-${BR}-$(date +%Y%m%d-%H%M%S)"
            git checkout -b "$SYNC_BRANCH" "origin/$BR"
            git merge "upstream/$BR" --no-edit || true
            git push origin "$SYNC_BRANCH"
            BRANCHES="$BRANCHES $SYNC_BRANCH"
          done
          echo "sync_branches=$BRANCHES" >> $GITHUB_ENV
          echo "Branches synced: $BRANCHES"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "ğŸ”„ Sync from Upstream"
          body: |
            Upstream åŒæ­¥å®Œæˆã€‚
            åŒæ­¥äº§ç”Ÿçš„åˆ†æ”¯ï¼š
            ${{ env.sync_branches }}
          branch: "sync-upstream-auto"
          labels: ["sync", "automated"]

      - name: Notify Telegram
        if: env.TELEGRAM_ENABLE == 'true'
        run: |
          MSG="Upstream Sync å®Œæˆã€‚"
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d text="$MSG"
