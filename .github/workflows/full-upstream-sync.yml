name: Full Upstream Sync (Best Version)

on:
  schedule:
    - cron: "0 18 * * *"  # æ¯å¤© 18:00
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  watch:
    types: [started]

env:
  UPSTREAM_REPO: "https://github.com/xxxxx/xxxxx.git"
  SYNC_BRANCH_PREFIX: "sync-upstream"
  SYNC_BRANCHES: "main dev release"   # å¯è‡ªç”±è°ƒæ•´
  TELEGRAM_ENABLE: "true"             # â† å¡« true å¼€å¯é€šçŸ¥
  DISCORD_ENABLE: "false"

jobs:
  sync:
    runs-on: ubuntu-latest
    if: github.event.repository.owner.id == github.event.sender.id

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          if git remote | grep -q '^upstream$'; then
            echo "Upstream exists."
          else
            git remote add upstream $UPSTREAM_REPO
          fi
          git fetch upstream --tags

      - name: Detect default branch
        id: branch
        run: |
          DEFAULT=$(git symbolic-ref refs/remotes/origin/HEAD | sed 's@^refs/remotes/origin/@@')
          echo "default_branch=$DEFAULT" >> $GITHUB_OUTPUT

      - name: Sync branches
        run: |
          BRANCHES=""
          for BR in $SYNC_BRANCHES; do
            echo ">>> Syncing branch: $BR"
            if ! git branch -a | grep -q "origin/$BR"; then
              echo "Branch $BR not found, skip."
              continue
            fi
            SYNC_BRANCH="${SYNC_BRANCH_PREFIX}-${BR}-$(date +%Y%m%d-%H%M%S)"
            git checkout -b "$SYNC_BRANCH" "origin/$BR"
            git merge "upstream/$BR" --no-edit || true
            git push origin "$SYNC_BRANCH"
            BRANCHES="$BRANCHES $SYNC_BRANCH"
          done
          echo "sync_branches=$BRANCHES" >> $GITHUB_ENV

      - name: Create Pull Requests
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "ğŸ”„ Sync from Upstream"
          body: |
            è‡ªåŠ¨ä» upstream åŒæ­¥ã€‚
            åŒæ­¥åˆ†æ”¯ï¼š
            ```
            ${{ env.sync_branches }}
            ```
            è‹¥å‡ºç°å†²çªï¼Œè¯·æŒ‰ Issue æç¤ºå¤„ç†ã€‚
          branch: ${{ env.sync_branches }}
          labels: ["sync", "automated"]

      - name: Detect merge conflicts
        run: |
          if git ls-files -u | grep -q .; then
            echo "conflict=true" >> $GITHUB_ENV
          else
            echo "conflict=false" >> $GITHUB_ENV
          fi

      - name: Create Conflict Issue
        if: env.conflict == 'true'
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "â— Upstream Sync Merge Conflict"
          content-filepath: .github/CONFLICT_TEMPLATE.md
          labels: conflict

      - name: Sync tags
        run: git push origin --tags

      - name: Auto merge PR (if no conflict)
        if: env.conflict == 'false'
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          merge-method: squash

      - name: Notify Telegram
        if: env.TELEGRAM_ENABLE == 'true'
        run: |
          MSG="Upstream Sync å®Œæˆã€‚å†²çªçŠ¶æ€ï¼š${{ env.conflict }}"
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d text="$MSG"
