name: ğŸ”„ Upstream Sync Automation

on:
  schedule:
    - cron: '0 8 * * *'  # æ¯å¤© UTC æ—¶é—´ 8:00
  workflow_dispatch:
    inputs:
      target_branches:
        description: 'è¦åŒæ­¥çš„åˆ†æ”¯ï¼ˆé€—å·åˆ†éš”ï¼‰'
        required: false
        default: 'main,dev,release'
      skip_notifications:
        description: 'è·³è¿‡é€šçŸ¥'
        required: false
        default: false
        type: boolean

env:
  UPSTREAM_REPO: https://github.com/ORIGINAL_OWNER/ORIGINAL_REPO.git
  SYNC_BRANCH_PREFIX: 'chore/sync-upstream'
  GIT_USER_NAME: 'ğŸ¤– Upstream Sync Bot'
  GIT_USER_EMAIL: 'actions@users.noreply.github.com'

jobs:
  sync-upstream:
    name: 'ğŸ”„ Sync Upstream'
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        branch: ['main', 'dev', 'release']
        include:
          - branch: 'main'
            labels: 'sync,production'
          - branch: 'dev'
            labels: 'sync,development'
          - branch: 'release'
            labels: 'sync,release'
    
    steps:
      - name: 'ğŸ“¥ Checkout repository'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: recursive

      - name: 'âš™ï¸ Configure Git'
        run: |
          git config --global user.name '${{ env.GIT_USER_NAME }}'
          git config --global user.email '${{ env.GIT_USER_EMAIL }}'
          git config --global pull.rebase false

      - name: 'ğŸ”— Add upstream remote'
        run: |
          git remote add upstream ${{ env.UPSTREAM_REPO }}

      - name: 'ğŸ“¡ Fetch upstream changes'
        run: |
          git fetch upstream --tags
          git fetch upstream

      - name: 'ğŸ” Check for changes'
        id: check_changes
        run: |
          echo "æ£€æŸ¥ä¸Šæ¸¸ ${{ matrix.branch }} åˆ†æ”¯çš„æ›´æ”¹..."
          
          # åˆ›å»ºä¸´æ—¶åˆ†æ”¯è¿›è¡Œæ¯”è¾ƒ
          git checkout -b temp-check upstream/${{ matrix.branch }}
          git checkout ${{ matrix.branch }}
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…æ›´æ”¹ï¼ˆæ’é™¤åˆå¹¶æäº¤ï¼‰
          if ! git diff --quiet ${{ matrix.branch }} temp-check -- . ':!*.md' ':!docs/' ':!CHANGELOG*'; then
            echo "changes_detected=true" >> $GITHUB_OUTPUT
            echo "ğŸ”„ æ£€æµ‹åˆ° ${{ matrix.branch }} åˆ†æ”¯æœ‰å®è´¨æ€§æ›´æ”¹"
            
            # è·å–æ›´æ”¹ç»Ÿè®¡
            CHANGES=$(git diff --stat ${{ matrix.branch }} temp-check)
            echo "changes_summary<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "changes_detected=false" >> $GITHUB_OUTPUT
            echo "âœ… ${{ matrix.branch }} åˆ†æ”¯æ— å®è´¨æ€§æ›´æ”¹"
          fi
          
          # æ¸…ç†ä¸´æ—¶åˆ†æ”¯
          git branch -D temp-check

      - name: 'ğŸ”„ Create sync branch and merge'
        if: steps.check_changes.outputs.changes_detected == 'true'
        id: merge
        run: |
          set -e
          
          SYNC_BRANCH="${{ env.SYNC_BRANCH_PREFIX }}-${{ matrix.branch }}-$(date +%s)"
          echo "branch_name=$SYNC_BRANCH" >> $GITHUB_OUTPUT
          
          # åˆ›å»ºåŒæ­¥åˆ†æ”¯
          git checkout -b $SYNC_BRANCH
          
          echo "æ­£åœ¨åˆå¹¶ä¸Šæ¸¸ ${{ matrix.branch }} åˆ†æ”¯..."
          if git merge --no-edit --no-ff --no-commit upstream/${{ matrix.branch }}; then
            # è‡ªåŠ¨åˆå¹¶æˆåŠŸï¼Œåˆ›å»ºæäº¤
            git commit -m "ğŸ”€ chore: sync upstream ${{ matrix.branch }}
            
            Automated sync from upstream repository:
            - Source: ${{ env.UPSTREAM_REPO }}
            - Branch: ${{ matrix.branch }}
            - Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
            
            Changes included:
            ${{ steps.check_changes.outputs.changes_summary }}"
            
            echo "merge_status=success" >> $GITHUB_OUTPUT
            echo "âœ… è‡ªåŠ¨åˆå¹¶æˆåŠŸ"
            
          else
            # åˆå¹¶å†²çªï¼Œå¤„ç†å†²çªåœºæ™¯
            echo "merge_status=conflict" >> $GITHUB_OUTPUT
            echo "âš ï¸ æ£€æµ‹åˆ°åˆå¹¶å†²çª"
            
            # å›æ»šåˆå¹¶å°è¯•
            git merge --abort 2>/dev/null || true
            
            # å°è¯•ä½¿ç”¨ theirs ç­–ç•¥ï¼ˆæ¥å—ä¸Šæ¸¸æ›´æ”¹ï¼‰
            if git merge --no-edit -Xtheirs upstream/${{ matrix.branch }}; then
              echo "merge_status=resolved_with_theirs" >> $GITHUB_OUTPUT
              git commit -m "ğŸ”€ chore: sync upstream ${{ matrix.branch }} (auto-resolve conflicts with upstream)
              
              Automated sync with conflict resolution:
              - Used 'theirs' strategy to prefer upstream changes
              - Manual review recommended
              - Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
              echo "âœ… ä½¿ç”¨ theirs ç­–ç•¥è§£å†³å†²çª"
            else
              echo "âŒ æ— æ³•è‡ªåŠ¨è§£å†³å†²çª"
              exit 1
            fi
          fi
          
          # æ›´æ–°å­æ¨¡å—ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -f .gitmodules ]; then
            echo "æ›´æ–°å­æ¨¡å—..."
            git submodule update --remote --merge
            if ! git diff --quiet --submodule; then
              git add .
              git commit -m "ğŸ“¦ chore: update submodules after upstream sync"
            fi
          fi

      - name: 'ğŸ“¤ Push sync branch'
        if: steps.check_changes.outputs.changes_detected == 'true' && steps.merge.outputs.merge_status != 'conflict'
        run: |
          git push origin ${{ steps.merge.outputs.branch_name }}
          echo "âœ… åŒæ­¥åˆ†æ”¯å·²æ¨é€: ${{ steps.merge.outputs.branch_name }}"

      - name: 'ğŸ”„ Create Pull Request'
        if: steps.check_changes.outputs.changes_detected == 'true' && steps.merge.outputs.merge_status != 'conflict'
        uses: actions/github-script@v7
        id: create_pr
        with:
          script: |
            const { branch, labels } = process.env;
            const context = require('./context');
            
            const syncBranch = '${{ steps.merge.outputs.branch_name }}';
            const baseBranch = '${{ matrix.branch }}';
            const mergeStatus = '${{ steps.merge.outputs.merge_status }}';
            const changesSummary = `${{ steps.check_changes.outputs.changes_summary }}`;
            
            try {
              const pr = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸ”€ Sync upstream changes to ${baseBranch}`,
                head: syncBranch,
                base: baseBranch,
                body: `## ğŸ”„ ä¸Šæ¸¸åŒæ­¥è¯·æ±‚
                
### ğŸ“Š åŒæ­¥ä¿¡æ¯
- **ä¸Šæ¸¸ä»“åº“**: ${'${{ env.UPSTREAM_REPO }}'}
- **ç›®æ ‡åˆ†æ”¯**: \`${baseBranch}\`
- **åŒæ­¥åˆ†æ”¯**: \`${syncBranch}\`
- **åˆå¹¶çŠ¶æ€**: ${mergeStatus === 'resolved_with_theirs' ? 'âœ… è‡ªåŠ¨è§£å†³å†²çª (ä½¿ç”¨ä¸Šæ¸¸ç‰ˆæœ¬)' : 'âœ… è‡ªåŠ¨åˆå¹¶æˆåŠŸ'}
- **åŒæ­¥æ—¶é—´**: ${new Date().toISOString()}

### ğŸ“ˆ æ›´æ”¹ç»Ÿè®¡
\`\`\`
${changesSummary}
\`\`\`

### ğŸ” æ£€æŸ¥æ¸…å•
- [ ] æ£€æŸ¥ CI æµ‹è¯•çŠ¶æ€
- [ ] éªŒè¯åŠŸèƒ½å®Œæ•´æ€§
- [ ] ç¡®è®¤æ— ç ´åæ€§å˜æ›´
- [ ] æ£€æŸ¥ä¾èµ–æ›´æ–°å½±å“

### âš ï¸ æ³¨æ„äº‹é¡¹
${mergeStatus === 'resolved_with_theirs' ? '> ğŸš¨ æ­¤åŒæ­¥åŒ…å«è‡ªåŠ¨å†²çªè§£å†³ï¼Œè¯·ä»”ç»†æ£€æŸ¥å†²çªæ–‡ä»¶' : '> âœ… æ­¤åŒæ­¥ä¸ºæ— å†²çªè‡ªåŠ¨åˆå¹¶'}

---
*ğŸ¤– æ­¤ PR ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º*`
              });
              
              console.log(`âœ… PR åˆ›å»ºæˆåŠŸ: ${pr.data.html_url}`);
              
              // æ·»åŠ æ ‡ç­¾
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.data.number,
                labels: ['auto-sync', 'upstream'].concat('${{ matrix.labels }}'.split(','))
              });
              
              // æ·»åŠ  Reviewerï¼ˆå¦‚æœæœ‰é…ç½®ï¼‰
              if ('${{ secrets.PR_REVIEWERS }}') {
                await github.rest.pulls.requestReviewers({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.data.number,
                  reviewers: '${{ secrets.PR_REVIEWERS }}'.split(',')
                });
              }
              
              return pr.data.html_url;
              
            } catch (error) {
              console.error('âŒ åˆ›å»º PR å¤±è´¥:', error);
              core.setFailed(`åˆ›å»º PR å¤±è´¥: ${error.message}`);
            }

      - name: 'ğŸš¨ Create Conflict Issue'
        if: steps.check_changes.outputs.changes_detected == 'true' && steps.merge.outputs.merge_status == 'conflict'
        uses: actions/github-script@v7
        with:
          script: |
            const baseBranch = '${{ matrix.branch }}';
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ ä¸Šæ¸¸åŒæ­¥å†²çª - ${baseBranch} åˆ†æ”¯`,
              labels: ['conflict', 'upstream-sync', 'need-attention'],
              body: `## ğŸš¨ ä¸Šæ¸¸åŒæ­¥å†²çªæ£€æµ‹
              
### ğŸ“‹ å†²çªä¿¡æ¯
- **åˆ†æ”¯**: \`${baseBranch}\`
- **ä¸Šæ¸¸ä»“åº“**: ${'${{ env.UPSTREAM_REPO }}'}
- **æ£€æµ‹æ—¶é—´**: ${new Date().toISOString()}
- **åŒæ­¥åˆ†æ”¯**: \`${{ steps.merge.outputs.branch_name }}\`

### ğŸ”§ éœ€è¦æ‰‹åŠ¨æ“ä½œ
æ£€æµ‹åˆ°æ— æ³•è‡ªåŠ¨è§£å†³çš„åˆå¹¶å†²çªï¼Œéœ€è¦æ‰‹åŠ¨å¹²é¢„ï¼š

1. æ£€æŸ¥åŒæ­¥åˆ†æ”¯: \`${{ steps.merge.outputs.branch_name }}\`
2. æ‰‹åŠ¨è§£å†³å†²çªæ–‡ä»¶
3. å®Œæˆåˆå¹¶åå…³é—­æ­¤ Issue

### ğŸ’¡ å»ºè®®æ­¥éª¤
\`\`\`bash
git fetch origin
git checkout ${{ steps.merge.outputs.branch_name }}
# æ‰‹åŠ¨è§£å†³å†²çª...
git add .
git commit -m "resolve upstream sync conflicts"
git push origin ${{ steps.merge.outputs.branch_name }}
\`\`\`

---
*ğŸ¤– ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º*`
            });
            
            console.log(`âœ… å†²çª Issue åˆ›å»ºæˆåŠŸ: ${issue.data.html_url}`);

      - name: 'ğŸ“¢ Send Telegram Notification'
        if: always() && github.event.inputs.skip_notifications != 'true'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            ${{ job.status == 'success' && 'âœ…' : 'âŒ' }} *ä¸Šæ¸¸åŒæ­¥å®Œæˆ*
            ğŸ“ *ä»“åº“:* ${{ github.repository }}
            ğŸŒ¿ *åˆ†æ”¯:* ${{ matrix.branch }}
            ğŸ”„ *çŠ¶æ€:* ${{ steps.check_changes.outputs.changes_detected == 'false' && 'æ— æ›´æ”¹' : (steps.merge.outputs.merge_status == 'success' && 'è‡ªåŠ¨åˆå¹¶' : (steps.merge.outputs.merge_status == 'conflict' && 'å†²çªéœ€æ‰‹åŠ¨è§£å†³' : 'å…¶ä»–çŠ¶æ€')) }}
            ${{ steps.create_pr.outputs.result && format('ğŸ“ PR: {0}', steps.create_pr.outputs.result) || '' }}
            â° *æ—¶é—´:* $(date -u +"%Y-%m-%d %H:%M UTC")

      - name: 'ğŸ“¢ Send Discord Notification'
        if: always() && github.event.inputs.skip_notifications != 'true'
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: ${{ job.status }}
          title: "ğŸ”„ ä¸Šæ¸¸åŒæ­¥çŠ¶æ€ - ${{ matrix.branch }}"
          description: |
            **ä»“åº“:** ${{ github.repository }}
            **åˆ†æ”¯:** ${{ matrix.branch }}
            **çŠ¶æ€:** ${{ steps.check_changes.outputs.changes_detected == 'false' && 'âœ… æ— æ›´æ”¹' : (steps.merge.outputs.merge_status == 'success' && 'âœ… è‡ªåŠ¨åˆå¹¶' : (steps.merge.outputs.merge_status == 'conflict' && 'ğŸš¨ å†²çªéœ€è§£å†³' : 'âš ï¸ å…¶ä»–çŠ¶æ€')) }}
            ${{ steps.create_pr.outputs.result && format('**PR:** <%s>', steps.create_pr.outputs.result) || '' }}
          color: ${{ steps.check_changes.outputs.changes_detected == 'false' && '00ff00' : (steps.merge.outputs.merge_status == 'success' && '00ff00' : (steps.merge.outputs.merge_status == 'conflict' && 'ff0000' : 'ffff00')) }}
          username: "Upstream Sync Bot"
          avatar_url: "https://github.com/github.png"

      - name: 'ğŸ§¹ Cleanup'
        if: always()
        run: |
          git remote remove upstream || true
