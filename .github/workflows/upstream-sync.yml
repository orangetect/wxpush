name: ğŸ”„ Sync wxpush Upstream

on:
  schedule:
    - cron: '0 20 * * *'  # æ¯å¤© UTC 20:00 (åŒ—äº¬æ—¶é—´æ¬¡æ—¥4:00)
  workflow_dispatch:
    inputs:
      skip_notifications:
        description: 'è·³è¿‡é€šçŸ¥'
        required: false
        default: false
        type: boolean

env:
  UPSTREAM_REPO: https://github.com/frankiejun/wxpush.git
  SYNC_BRANCH_PREFIX: 'chore/sync-upstream'
  GIT_USER_NAME: 'ğŸ¤– Upstream Sync Bot'
  GIT_USER_EMAIL: 'actions@users.noreply.github.com'

jobs:
  sync-upstream:
    name: 'ğŸ”„ Sync wxpush Upstream'
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        branch: ['main']  # æ ¹æ® wxpush ä»“åº“çš„å®é™…åˆ†æ”¯è°ƒæ•´

    steps:
      - name: 'ğŸ“¥ Checkout repository'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 'âš™ï¸ Configure Git'
        run: |
          git config --global user.name '${{ env.GIT_USER_NAME }}'
          git config --global user.email '${{ env.GIT_USER_EMAIL }}'
          git config --global pull.rebase false

      - name: 'ğŸ”— Add upstream remote'
        run: |
          git remote add upstream ${{ env.UPSTREAM_REPO }}
          echo "âœ… å·²æ·»åŠ ä¸Šæ¸¸ä»“åº“: ${{ env.UPSTREAM_REPO }}"

      - name: 'ğŸ“¡ Fetch upstream changes'
        run: |
          echo "æ­£åœ¨è·å–ä¸Šæ¸¸ä»“åº“æ›´æ–°..."
          git fetch upstream
          git fetch upstream --tags
          echo "âœ… ä¸Šæ¸¸ä»“åº“æ›´æ–°è·å–å®Œæˆ"

      - name: 'ğŸ” Check for changes'
        id: check_changes
        run: |
          echo "æ£€æŸ¥ä¸Šæ¸¸ ${{ matrix.branch }} åˆ†æ”¯çš„æ›´æ”¹..."
          
          # è·å–ä¸Šæ¸¸åˆ†æ”¯çš„æäº¤ä¿¡æ¯
          UPSTREAM_COMMITS=$(git log ${{ matrix.branch }}..upstream/${{ matrix.branch }} --oneline | head -5)
          COMMIT_COUNT=$(git rev-list --count ${{ matrix.branch }}..upstream/${{ matrix.branch }} 2>/dev/null || echo "0")
          
          if [ "$COMMIT_COUNT" -gt 0 ]; then
            echo "changes_detected=true" >> $GITHUB_OUTPUT
            echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT
            echo "upstream_commits<<EOF" >> $GITHUB_OUTPUT
            echo "$UPSTREAM_COMMITS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "ğŸ”„ æ£€æµ‹åˆ° $COMMIT_COUNT ä¸ªæ–°æäº¤éœ€è¦åŒæ­¥"
            echo "æœ€è¿‘æäº¤:"
            echo "$UPSTREAM_COMMITS"
          else
            echo "changes_detected=false" >> $GITHUB_OUTPUT
            echo "commit_count=0" >> $GITHUB_OUTPUT
            echo "âœ… ${{ matrix.branch }} åˆ†æ”¯å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€åŒæ­¥"
          fi

      - name: 'ğŸ”„ Create sync branch and merge'
        if: steps.check_changes.outputs.changes_detected == 'true'
        id: merge
        run: |
          set -e
          
          SYNC_BRANCH="${{ env.SYNC_BRANCH_PREFIX }}-${{ matrix.branch }}-$(date +%Y%m%d-%H%M%S)"
          echo "branch_name=$SYNC_BRANCH" >> $GITHUB_OUTPUT
          
          echo "åˆ›å»ºåŒæ­¥åˆ†æ”¯: $SYNC_BRANCH"
          git checkout -b "$SYNC_BRANCH"
          
          echo "æ­£åœ¨åˆå¹¶ä¸Šæ¸¸ ${{ matrix.branch }} åˆ†æ”¯..."
          if git merge --no-edit --no-ff upstream/${{ matrix.branch }}; then
            echo "merge_status=success" >> $GITHUB_OUTPUT
            echo "âœ… è‡ªåŠ¨åˆå¹¶æˆåŠŸ"
            
            # åˆ›å»ºåˆå¹¶æäº¤ä¿¡æ¯
            git commit --amend -m "ğŸ”€ chore: sync upstream ${{ matrix.branch }
            
            Automated sync from upstream repository:
            - Source: ${{ env.UPSTREAM_REPO }}
            - Branch: ${{ matrix.branch }}
            - Commits: ${{ steps.check_changes.outputs.commit_count }}
            - Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
            
            Recent changes:
            ${{ steps.check_changes.outputs.upstream_commits }}"
            
          else
            echo "merge_status=conflict" >> $GITHUB_OUTPUT
            echo "âŒ åˆå¹¶å†²çªï¼Œéœ€è¦æ‰‹åŠ¨è§£å†³"
            git merge --abort 2>/dev/null || true
            exit 1
          fi

      - name: 'ğŸ“¤ Push sync branch'
        if: steps.check_changes.outputs.changes_detected == 'true' && steps.merge.outputs.merge_status == 'success'
        run: |
          echo "æ¨é€åŒæ­¥åˆ†æ”¯åˆ°è¿œç¨‹ä»“åº“..."
          git push origin "${{ steps.merge.outputs.branch_name }}"
          echo "âœ… åŒæ­¥åˆ†æ”¯å·²æ¨é€: ${{ steps.merge.outputs.branch_name }}"

      - name: 'ğŸ”„ Create Pull Request'
        if: steps.check_changes.outputs.changes_detected == 'true' && steps.merge.outputs.merge_status == 'success'
        uses: actions/github-script@v7
        id: create_pr
        with:
          script: |
            const syncBranch = '${{ steps.merge.outputs.branch_name }}';
            const baseBranch = '${{ matrix.branch }}';
            const commitCount = '${{ steps.check_changes.outputs.commit_count }}';
            const upstreamCommits = `${{ steps.check_changes.outputs.upstream_commits }}`;
            
            try {
              const pr = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸ”€ Sync upstream changes to ${baseBranch}`,
                head: syncBranch,
                base: baseBranch,
                body: `## ğŸ”„ ä¸Šæ¸¸åŒæ­¥è¯·æ±‚
                
### ğŸ“Š åŒæ­¥ä¿¡æ¯
- **ä¸Šæ¸¸ä»“åº“**: [frankiejun/wxpush](${{ env.UPSTREAM_REPO }})
- **ç›®æ ‡åˆ†æ”¯**: \`${baseBranch}\`
- **åŒæ­¥åˆ†æ”¯**: \`${syncBranch}\`
- **æ–°æäº¤æ•°é‡**: ${commitCount}
- **åŒæ­¥æ—¶é—´**: ${new Date().toISOString()}

### ğŸ“ æœ€è¿‘æäº¤
\`\`\`
${upstreamCommits}
\`\`\`

### ğŸ” æ£€æŸ¥æ¸…å•
- [ ] æ£€æŸ¥ CI æµ‹è¯•çŠ¶æ€
- [ ] éªŒè¯å¾®ä¿¡æ¨é€åŠŸèƒ½æ­£å¸¸
- [ ] ç¡®è®¤é…ç½®æ–‡ä»¶å…¼å®¹æ€§
- [ ] æµ‹è¯•ä¾èµ–æ›´æ–°å½±å“

### âš ï¸ æ³¨æ„äº‹é¡¹
æ­¤åŒæ­¥åŒ…å«ä»ä¸Šæ¸¸ä»“åº“ [frankiejun/wxpush] è‡ªåŠ¨åˆå¹¶çš„æ›´æ”¹ï¼Œè¯·ä»”ç»†æ£€æŸ¥ï¼š

1. é…ç½®æ–‡ä»¶æ˜¯å¦æœ‰å†²çª
2. ä¾èµ–ç‰ˆæœ¬æ˜¯å¦å…¼å®¹
3. æ ¸å¿ƒåŠŸèƒ½æ˜¯å¦æ­£å¸¸

---
*ğŸ¤– æ­¤ PR ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º*`
              });
              
              console.log(`âœ… PR åˆ›å»ºæˆåŠŸ: ${pr.data.html_url}`);
              
              // æ·»åŠ æ ‡ç­¾
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.data.number,
                labels: ['auto-sync', 'upstream', 'wxpush']
              });
              
              // è®¾ç½® PR è¾“å‡º
              core.setOutput('pr_url', pr.data.html_url);
              
            } catch (error) {
              console.error('âŒ åˆ›å»º PR å¤±è´¥:', error);
              core.setFailed(`åˆ›å»º PR å¤±è´¥: ${error.message}`);
            }

      - name: 'ğŸ“¢ Send Telegram Notification'
        if: always() && github.event.inputs.skip_notifications != 'true'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            ${{ job.status == 'success' && 'âœ…' : 'âŒ' }} *wxpush ä¸Šæ¸¸åŒæ­¥å®Œæˆ*
            ğŸ“ *ä»“åº“:* ${{ github.repository }}
            ğŸŒ¿ *åˆ†æ”¯:* ${{ matrix.branch }}
            ${{ steps.check_changes.outputs.changes_detected == 'true' && format('ğŸ”„ *æ–°æäº¤:* {0}', steps.check_changes.outputs.commit_count) || 'âœ… *çŠ¶æ€:* æ— æ–°æ›´æ”¹' }}
            ${{ steps.create_pr.outputs.pr_url && format('ğŸ“ *PR:* {0}', steps.create_pr.outputs.pr_url) || '' }}
            ${{ job.status == 'failure' && 'âŒ ä»»åŠ¡å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—' : '' }}
            â° *æ—¶é—´:* $(date -u +"%Y-%m-%d %H:%M UTC")

      - name: 'ğŸ“¢ Send Discord Notification'
        if: always() && github.event.inputs.skip_notifications != 'true' && secrets.DISCORD_WEBHOOK
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "ğŸ”„ wxpush ä¸Šæ¸¸åŒæ­¥ - ${{ job.status }}"
          description: |
            **ä»“åº“:** ${{ github.repository }}
            **åˆ†æ”¯:** ${{ matrix.branch }}
            **çŠ¶æ€:** ${{ steps.check_changes.outputs.changes_detected == 'true' && 'æœ‰æ›´æ–°' : 'æ— æ›´æ–°' }}
            **æäº¤æ•°:** ${{ steps.check_changes.outputs.commit_count }}
            ${{ steps.create_pr.outputs.pr_url && format('**PR:** <%s>', steps.create_pr.outputs.pr_url) || '' }}
          color: ${{ job.status == 'success' && '00ff00' : 'ff0000' }}

      - name: 'ğŸ§¹ Cleanup'
        if: always()
        run: |
          git remote remove upstream || true
          echo "âœ… æ¸…ç†å®Œæˆ"
