on:
  workflow_dispatch: {}
  push:
    branches:
      - main

concurrency:
  group: sync-upstream-${{ github.repository }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  UPSTREAM_REPO: "https://github.com/frankiejun/wxpush.git"  # <-- æ”¹ä¸ºä¸Šæ¸¸ä»“åº“ URL
  SYNC_BRANCH_PREFIX: "sync-upstream"
  SYNC_BRANCHES: "main dev release"   # <-- æ ¹æ®éœ€è¦è°ƒæ•´
  TELEGRAM_ENABLE: "true"             # true åˆ™å‘é€ Telegram é€šçŸ¥ï¼ˆéœ€ secretsï¼‰
  DISCORD_ENABLE: "false"

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Owner-only for manual runs
        if: github.event_name == 'workflow_dispatch'
        run: |
          if [ "${{ github.actor }}" != "${{ github.repository_owner }}" ]; then
            echo "Only repository owner (${{
              github.repository_owner
            }}) may run this workflow manually. Triggering actor: ${{ github.actor }}."
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote and fetch
        run: |
          if git remote | grep -q '^upstream$'; then
            echo "Upstream exists."
          else
            git remote add upstream "$UPSTREAM_REPO"
          fi
          git fetch upstream --tags --prune
          git fetch origin --prune

      - name: Prepare vars
        id: prep
        run: |
          REPO_FULL="${{ github.repository }}"    # owner/repo
          REPO_OWNER="${{ github.repository_owner }}"
          REPO_NAME="${REPO_FULL#*/}"
          echo "repo_full=$REPO_FULL" >> $GITHUB_OUTPUT
          echo "repo_owner=$REPO_OWNER" >> $GITHUB_OUTPUT
          echo "repo_name=$REPO_NAME" >> $GITHUB_OUTPUT

      - name: Sync branches and create PRs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          REPO_FULL="${{ steps.prep.outputs.repo_full }}"
          REPO_OWNER="${{ steps.prep.outputs.repo_owner }}"
          echo "Repository: $REPO_FULL ; Owner: $REPO_OWNER"

          SYNCED=""
          for BR in $SYNC_BRANCHES; do
            echo ">>> Processing upstream branch: $BR"

            # Ensure origin has the branch
            if ! git ls-remote --exit-code origin refs/heads/"$BR" >/dev/null 2>&1; then
              echo "Origin does not have branch $BR â€” skipping."
              continue
            fi

            TIMESTAMP=$(date -u +"%Y%m%d-%H%M%S")
            SYNC_BRANCH="${SYNC_BRANCH_PREFIX}-${BR}-${TIMESTAMP}"
            echo "Creating local branch $SYNC_BRANCH from origin/$BR"
            git checkout -b "$SYNC_BRANCH" "origin/$BR"

            echo "Merging upstream/$BR into $SYNC_BRANCH"
            # Fetch upstream branch and attempt merge
            if git fetch upstream "$BR":"refs/remotes/upstream/$BR"; then
              if ! git merge --no-edit "upstream/$BR"; then
                echo "Merge reported conflicts for $BR"
              fi
            else
              echo "Could not fetch upstream/$BR, skipping merge step."
            fi

            # Detect conflicts
            if git ls-files -u | grep -q .; then
              echo "Conflict detected when merging upstream/$BR into $SYNC_BRANCH"
              CONFLICT=true
            else
              CONFLICT=false
            fi

            echo "Pushing $SYNC_BRANCH to origin"
            git push origin "$SYNC_BRANCH"

            # Create PR in the fork repo (origin)
            PR_TITLE="ðŸ”„ Sync from Upstream: $BR"
            PR_BODY="è‡ªåŠ¨ä»Ž upstream åŒæ­¥ã€‚\n\nåŒæ­¥åˆ†æ”¯ï¼š\n- upstream/$BR -> $SYNC_BRANCH\n\nå†²çªï¼š $CONFLICT"

            create_response=$(curl -s -o /dev/stderr -w "%{http_code}" -X POST \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              https://api.github.com/repos/$REPO_FULL/pulls \
              -d "$(jq -n --arg t "$PR_TITLE" --arg h "$SYNC_BRANCH" --arg b "$BR" --arg body "$PR_BODY" \
                    '{title:$t, head:$h, base:$b, body:$body}')") || true

            # If 201 created then good, if 422 maybe PR exists â€” try to find existing PR
            if [ "$create_response" = "201" ]; then
              echo "PR created for $SYNC_BRANCH -> $BR"
            else
              echo "PR creation status: $create_response (may already exist). Attempting to find existing PR."
              # try to find existing PR
              existing=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/$REPO_FULL/pulls?head=${REPO_OWNER}:${SYNC_BRANCH}&base=$BR")
              if echo "$existing" | jq -e '.[0] | .html_url' >/dev/null 2>&1; then
                url=$(echo "$existing" | jq -r '.[0].html_url')
                echo "Found existing PR: $url"
              else
                echo "No existing PR found or creation failed (HTTP $create_response)."
              fi
            fi

            # If conflict, create an issue to notify
            if [ "$CONFLICT" = "true" ]; then
              ISSUE_TITLE="â— Upstream Sync Merge Conflict: $BR"
              ISSUE_BODY="åœ¨å°è¯•å°† upstream/$BR åˆå¹¶åˆ° $BR æ—¶äº§ç”Ÿå†²çªã€‚\n\nSync branch: $SYNC_BRANCH\nè¯·æ‰‹åŠ¨è§£å†³å†²çªã€‚"

              curl -s -X POST \
                -H "Authorization: token $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                https://api.github.com/repos/$REPO_FULL/issues \
                -d "$(jq -n --arg t "$ISSUE_TITLE" --arg b "$ISSUE_BODY" '{title:$t, body:$b, labels:["conflict"]}')"
            fi

            SYNCED="$SYNCED $SYNC_BRANCH"
          done

          echo "synced_branches=$SYNCED" >> $GITHUB_ENV

      - name: Push tags
        run: |
          git push origin --tags || true

      - name: Telegram notify
        if: env.TELEGRAM_ENABLE == 'true'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          MSG="Upstream Sync completed on ${{ github.repository }}. Synced: ${{ env.synced_branches }}"
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="$MSG"
